# 复杂功能流程

> **适用场景**: 涉及架构调整、新技术引入、性能敏感

---

## 流程图

```
用户输入需求
    ↓
识别为复杂功能
    ↓
生成需求文档
    ↓
等待用户确认
    ↓
生成技术评估报告
    ↓
等待用户确认（2-3个方案对比）
    ↓
确定技术方案
    ↓
生成数据库设计文档
    ↓
等待用户确认
    ↓
生成API设计文档
    ↓
等待用户确认
    ↓
生成UI原型文档
    ↓
等待用户确认
    ↓
开始实施开发
    ↓
分阶段测试
    ↓
完成
```

---

## 判定标准

满足以下**任意一个**条件即为复杂功能：

- ✅ 涉及系统架构调整
- ✅ 需要引入新的技术栈或库
- ✅ 性能敏感（需要优化查询、缓存、异步处理）
- ✅ 需要重构现有功能
- ✅ 涉及数据迁移（大量现有数据需要处理）
- ✅ 安全性敏感（涉及权限、加密、支付）

---

## 与中等功能的区别

| 维度 | 中等功能 | 复杂功能 |
|------|----------|----------|
| 技术方案 | 简单方案（1个） | 技术评估（2-3个方案对比） |
| 可行性 | 默认可行 | 需要评估可行性 |
| 风险分析 | 简单列出 | 详细分析（概率、影响、应对） |
| 工作量估算 | 粗略估算 | 详细估算（按任务拆分） |
| 实施方式 | 直接开发 | 分阶段实施 |

---

## 核心环节：技术评估

### 为什么需要技术评估？

1. **验证可行性** - 这个功能技术上能实现吗？
2. **方案对比** - 有多种实现方案，哪个最优？
3. **风险识别** - 可能遇到什么问题？
4. **工作量评估** - 需要多少时间？

### 技术评估报告包含

**必须包含**：
- 可行性结论（可行/不可行/有条件可行）
- 技术难点分析
- **2-3个方案对比**（优缺点、工作量、风险）
- **推荐方案及理由**
- 风险评估（概率、影响、应对措施）
- 工作量详细估算

---

## 方案对比示例

### 场景：重构权限系统，实现RBAC

#### 方案A：使用Django Guardian（推荐）

**优点**：
- ✅ 成熟方案，社区活跃
- ✅ 支持对象级权限
- ✅ 与Django无缝集成

**缺点**：
- ⚠️ 需要额外依赖
- ⚠️ 学习成本

**工作量**：10个工作日

**风险**：低

---

#### 方案B：自研RBAC系统

**优点**：
- ✅ 完全可控
- ✅ 不依赖第三方

**缺点**：
- ❌ 开发周期长
- ❌ 维护成本高

**工作量**：15个工作日

**风险**：中

---

#### 方案C：使用Django RQL

**优点**：
- ✅ 轻量级
- ✅ 快速上手

**缺点**：
- ❌ 不支持复杂场景
- ❌ 扩展性差

**工作量**：5个工作日

**风险**：低（但功能受限）

---

#### 推荐方案：方案A

**理由**：
1. 成熟稳定，风险可控
2. 功能完整，支持未来扩展
3. 比自研节省5个工作日

---

## 分阶段实施

复杂功能不建议一次性完成，而是分阶段：

### 示例：RBAC权限系统

**第一阶段**（1周）：
- 实现基础RBAC模型（用户、角色、权限）
- 实现角色和权限管理界面
- 完成基础的权限校验

**第二阶段**（1周）：
- 迁移现有数据到新权限系统
- 完成前端权限控制（路由守卫、按钮权限）
- 编写权限管理文档

**第三阶段**（可选）：
- 实现对象级权限（用户只能操作自己的资源）
- 实现动态权限（运行时添加权限）
- 性能优化（缓存权限数据）

---

## 风险应对

### 常见风险类型

| 风险类型 | 应对措施 |
|----------|----------|
| 技术选型错误 | 技术评估阶段充分调研，POC验证 |
| 性能不达标 | 设计阶段考虑性能，预留优化空间 |
| 数据迁移失败 | 先在测试环境验证，做好备份 |
| 开发周期延误 | 预留缓冲时间，分阶段交付 |
| 用户学习成本 | 提供操作文档，渐进式迁移 |

---

## 示例

### 示例：重构权限系统为RBAC

**用户输入**: "重构现有权限系统，实现完整的RBAC"

**我的执行**：

#### 第1步：需求文档
```
功能概述：
- 支持角色管理（创建、编辑、删除角色）
- 支持权限管理（定义系统权限）
- 支持用户角色分配
- 支持对象级权限（用户只能操作自己的机器人）

详细功能点：
- ...（略）
```

**用户**: "OK"

#### 第2步：技术评估报告（关键环节）
```
可行性结论：✅ 可行，建议分阶段实施

技术难点分析：
- 现有数据迁移（难度：⭐⭐⭐⭐）
- 权限粒度设计（难度：⭐⭐⭐）
- 性能影响（难度：⭐⭐）

方案对比：
方案A：Django Guardian（推荐） - 10天
方案B：自研RBAC - 15天
方案C：Django RQL - 5天

推荐方案：方案A
理由：成熟稳定，功能完整，开发效率高

风险评估：
- 数据迁移失败：概率中，影响高 → 应对：先测试环境验证
- 性能下降：概率低，影响中 → 应对：使用Redis缓存
```

**用户**: "用方案A，分阶段实施"

#### 第3步：数据库设计
```
用户表：已有，需要扩展字段
角色表：rbac_role
权限表：rbac_permission
用户角色关联表：rbac_user_role
角色权限关联表：rbac_role_permission
```

**用户**: "OK"

#### 第4步：API设计
```
POST /api/rbac/role/create
GET /api/rbac/role/list
POST /api/rbac/role/assign-permission
...
```

**用户**: "OK"

#### 第5步：UI原型
```
角色管理页面
权限管理页面
用户角色分配页面
...
```

**用户**: "OK"

#### 第6步：分阶段实施
```
第一阶段（1周）：基础RBAC
第二阶段（1周）：数据迁移 + 前端权限
第三阶段（可选）：对象级权限
```

---

## 时间估算

| 阶段 | 预计时间 |
|------|----------|
| 需求文档 | 2分钟 |
| 技术评估报告 | 3分钟 |
| 方案确认 | - |
| 数据库设计 | 2分钟 |
| API设计 | 2分钟 |
| UI原型 | 2分钟 |
| **文档总耗时** | **约11分钟** |
| 等待确认 | - |
| 实施开发 | 根据复杂度（分阶段） |

---

## 注意事项

1. **技术评估是关键** - 不要跳过，否则可能返工
2. **方案对比要充分** - 至少2个方案，说明优缺点
3. **推荐方案要有理有据** - 为什么推荐这个方案
4. **分阶段实施** - 不要一次性做太多，先做核心功能
5. **风险要提前识别** - 不要等出了问题再应对

---

**最后更新**: 2025-01-05
