#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Git åˆ†æ”¯ç®¡ç†æ¨¡å—

ç®¡ç† Git åˆ†æ”¯çš„åˆ›å»ºã€æäº¤ã€åˆå¹¶ã€å›æ»š
"""

import subprocess


class GitManager:
    """Git ç®¡ç†å™¨"""

    def __init__(self, config):
        self.config = config

    def create_branch(self, branch_name):
        """åˆ›å»ºæ–°åˆ†æ”¯"""
        result = subprocess.run(
            ["git", "checkout", "-b", branch_name],
            capture_output=True,
            text=True
        )

        return result.returncode == 0

    def commit(self, category, message):
        """
        æäº¤ä¿®å¤

        Args:
            category: é—®é¢˜ç±»åˆ« (config/database/api/frontend)
            message: æäº¤æ¶ˆæ¯
        """
        commit_msg = f"""fix({category}): {message}

ğŸ¤– Auto-generated by Auto-Fix System
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
"""

        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        subprocess.run(["git", "add", "."], capture_output=True)

        # æäº¤
        result = subprocess.run(
            ["git", "commit", "-m", commit_msg],
            capture_output=True,
            text=True
        )

        return result.returncode == 0

    def merge_to_main(self, branch_name):
        """åˆå¹¶åˆ†æ”¯åˆ°ä¸»åˆ†æ”¯"""
        # åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯
        subprocess.run(["git", "checkout", "main"], capture_output=True)

        # åˆå¹¶
        result = subprocess.run(
            ["git", "merge", branch_name],
            capture_output=True,
            text=True
        )

        return result.returncode == 0

    def delete_branch(self, branch_name):
        """åˆ é™¤åˆ†æ”¯"""
        result = subprocess.run(
            ["git", "branch", "-d", branch_name],
            capture_output=True,
            text=True
        )

        return result.returncode == 0

    def rollback_last_commit(self):
        """å›æ»šæœ€åä¸€æ¬¡æäº¤"""
        result = subprocess.run(
            ["git", "reset", "--hard", "HEAD~1"],
            capture_output=True,
            text=True
        )

        return result.returncode == 0

    def get_current_branch(self):
        """è·å–å½“å‰åˆ†æ”¯å"""
        result = subprocess.run(
            ["git", "rev-parse", "--abbrev-ref", "HEAD"],
            capture_output=True,
            text=True
        )

        if result.returncode == 0:
            return result.stdout.strip()
        return None
