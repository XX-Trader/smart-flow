# Auto-Fix 循环使用指南

## 为什么使用循环技能？

Auto-Fix 默认执行**单次修复**：
- 测试 → 分析 → 修复 → 提交

配合**循环技能**（如 ralph-wiggum）可以实现：
- 自动循环执行，直到所有测试通过
- 更好的模块化设计（循环逻辑由专门的循环技能处理）
- 更灵活的控制（可以指定最多循环次数、停止条件等）

---

## 🚀 快速开始

### 使用 ralph-wiggum 循环技能

在 Claude Code 中说：

```
ralph-loop /auto-fix
```

或

```
启动 ralph-wiggum 循环 auto-fix
```

### 指定循环次数

```
ralph-loop /auto-fix 最多10次
```

### 手动停止循环

```
cancel-ralph
```

---

## 📊 退出码与状态

Auto-Fix 使用标准化的退出码和状态消息，ralph-wiggum 可以根据这些状态决定是否继续循环：

### 退出码说明

| 退出码 | 状态 | 说明 | ralph-wiggum 行为 |
|--------|------|------|-------------------|
| **0** | 完成 (DONE) | 所有测试通过，修复完成 | **停止循环** ✅ |
| **1** | 需要人工介入 (NEEDS_ATTENTION) | 需要人工处理（Git 问题、环境问题） | **停止循环** ⚠️ |
| **2** | 遇到复杂问题 (COMPLEX_PROBLEM) | 需要提前规划的问题（架构、业务逻辑） | **停止循环** 🔴 |
| **100** | 需要继续验证 (CONTINUE) | 部分问题已修复，需要重新测试 | **继续循环** 🔄 |

### 状态消息格式

```
======================================================================
状态: 完成 (0)
所有测试通过，修复流程已完成
======================================================================
```

ralph-wiggum 通过解析这种格式来理解 Auto-Fix 的执行状态。

---

## 🔄 循环流程

```
┌─────────────────────────────────────────────┐
│  ralph-wiggum: 循环 /auto-fix              │
├─────────────────────────────────────────────┤
│  第1轮:                                     │
│    ├─> 运行测试                             │
│    ├─> 分析问题                             │
│    │   └─> 分离复杂问题和可修复问题         │
│    ├─> 修复可修复问题 (simple/medium)      │
│    ├─> Git 提交                             │
│    └─> 检查退出码: 100 (CONTINUE)          │
│         └─> ralph-wiggum: 继续下一轮 ✓    │
│                                             │
│  第2轮:                                     │
│    ├─> 运行测试                             │
│    ├─> 分析问题                             │
│    ├─> 修复问题                             │
│    ├─> Git 提交                             │
│    └─> 检查退出码: 100 (CONTINUE)          │
│         └─> 继续第3轮...                    │
│                                             │
│  第N轮:                                     │
│    ├─> 运行测试                             │
│    └─> 所有测试通过 ✓                      │
│        └─> 退出码: 0 (DONE)                │
│            └─> ralph-wiggum: 停止循环 ✅  │
└─────────────────────────────────────────────┘
```

---

## 💡 使用场景

### 场景 1: 首次部署修复

```
ralph-loop /auto-fix
```

**预期效果**:
- 第1轮: 修复配置问题（端口、URL）→ 退出码 100
- 第2轮: 修复数据库问题（字段、迁移）→ 退出码 100
- 第3轮: 修复 API 问题（路由、参数）→ 退出码 100
- 第4轮: 修复前端问题（组件、选择器）→ 退出码 100
- 第5轮: 测试通过 → 退出码 0 → ralph-wiggum 停止 ✅

### 场景 2: 遇到复杂问题

```
ralph-loop /auto-fix
```

**预期效果**:
- 第1轮: 修复简单问题（端口、URL）→ 退出码 100
- 第2轮: 发现复杂问题（架构设计）→ 退出码 2 → ralph-wiggum 停止 ⚠️
- 人工规划解决方案
- 第3轮: 继续循环 `ralph-loop /auto-fix` → 退出码 100
- ...

**关键点**:
- ✅ 遇到复杂问题前，会先修复所有可修复的问题
- ✅ 可修复的代码会自动合并到主分支
- ✅ 只有问题无法继续时才停止循环

### 场景 3: 指定最大循环次数

```
ralph-loop /auto-fix 最多10次
```

**适用场景**:
- 防止无限循环
- 控制修复时间
- 分批修复复杂问题

---

## ⚙️ ralph-wiggum 参数

### 基本语法

```
ralph-loop <命令> [次数]
```

### 示例

```
# 自动循环直到完成或遇到复杂问题
ralph-loop /auto-fix

# 指定最多循环次数
ralph-loop /auto-fix 最多10次

# 手动停止
cancel-ralph
```

---

## 🎯 最佳实践

### 1. 首次使用

```bash
# 1. 初始化配置
/auto-fix --init-config

# 2. 修改配置文件
vim auto-fix.config.json

# 3. 启动循环
ralph-loop /auto-fix
```

### 2. 日常使用

```
# 快速修复（自动循环直到完成）
ralph-loop /auto-fix
```

### 3. 复杂问题处理

```
# 第1步: 先运行单次，查看问题类型
/auto-fix

# 第2步: 如果有复杂问题，人工规划解决方案
# （查看输出中的复杂问题列表）

# 第3步: 规划完成后，继续循环
ralph-loop /auto-fix
```

### 4. 调试模式

```
# 单次执行，观察每步结果
/auto-fix

# 检查修复分支
git log --oneline

# 查看当前状态
git status

# 确认无误后继续循环
ralph-loop /auto-fix
```

---

## ⚠️ 注意事项

### 复杂问题处理策略

**v2.0 新特性**: 遇到复杂问题时，Auto-Fix 会：
1. ✅ **继续修复所有可修复问题**（simple/medium 级别）
2. ✅ **自动合并已修复的代码**到主分支
3. ⚠️ **停止并报告复杂问题**，等待人工规划
4. 🔄 **规划后可继续循环**

**示例场景**:
```
发现 5 个问题:
  - 配置问题 (simple) ✓ 自动修复
  - 数据库字段缺失 (simple) ✓ 自动修复
  - API 路由 404 (simple) ✓ 自动修复
  - 架构重构需求 (complex) ⚠️ 停止并报告
  - 业务逻辑问题 (complex) ⚠️ 停止并报告

结果:
  ✅ 已修复 3 个简单问题
  ✅ 已合并到主分支
  ⚠️ 停止循环，报告 2 个复杂问题
  🔄 等待人工规划后继续
```

### Git 分支管理

- ✅ 每轮循环创建独立分支 `auto-fix-{timestamp}`
- ✅ 每个大类修复后独立提交
- ✅ 成功后自动合并到主分支
- ⚠️ 失败时保留分支，方便人工检查

### 循环次数

- ralph-wiggum 默认无限循环，直到退出码为 0、1 或 2
- 建议指定最多循环次数（如 10 次）防止意外
- 达到最大次数后 ralph-wiggum 会自动停止

---

## 🆘 故障排查

### 问题 1: 循环立即停止

**可能原因**:
- 退出码为 0（测试通过）- 正常
- 退出码为 1（环境问题）- 检查 Git、测试环境
- 退出码为 2（复杂问题）- 人工规划

**解决方法**:
```bash
# 查看最后的退出状态
/auto-fix

# 检查修复分支
git log --oneline

# 查看未修复的问题
cat test_reports/*.md
```

### 问题 2: 循环卡住不停止

**原因**: 某些问题反复出现，修复逻辑有问题

**解决方法**:
```bash
# 1. 手动停止循环
cancel-ralph

# 2. 检查修复历史
git log --oneline -20

# 3. 查看重复的问题
cat test_reports/*.md | grep "失败"

# 4. 人工分析并修复
```

### 问题 3: 分支冲突

**原因**: 多次循环可能产生分支冲突

**解决方法**:
```bash
# 1. 停止循环
cancel-ralph

# 2. 检查分支状态
git status

# 3. 解决冲突
# （手动解决或使用合并工具）

# 4. 继续循环
ralph-loop /auto-fix
```

---

## 📚 相关技能

- **ralph-wiggum** - Ralph Wiggum 循环技能（推荐）
- **循环** - 通用循环技能
- **deployment-test** - 部署后测试技能
- **auto-fix** - 自动修复技能（本技能）

---

**版本**: 2.0
**更新时间**: 2026-01-05
**主要更新**: 支持 ralph-wiggum，优化复杂问题处理策略
