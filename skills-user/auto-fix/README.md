# Auto-Fix 技能使用文档

> 全自动测试-修复循环系统 - 自动运行测试、分析问题、修复Bug、提交代码，直到所有测试通过

## 📖 概述

Auto-Fix 是一个 Claude Code 技能，可以自动执行部署测试并修复发现的问题。它会：

1. **运行测试** - 调用 `deployment-test` 技能执行完整测试
2. **分析问题** - 从测试报告中提取并分类问题（配置/数据库/API/前端）
3. **自动修复** - 根据问题类型执行对应的修复策略
4. **Git 提交** - 每个修复独立提交，便于追踪和回滚
5. **循环测试** - 修复后重新测试，直到所有测试通过或遇到复杂问题
6. **合并代码** - 成功后自动合并到主分支

### 核心特性

- ✅ **三阶段修复策略**: 配置 → 后端依赖链 → 前端
- ✅ **依赖优先**: 数据库 → API → 前端（按依赖顺序修复）
- ✅ **安全隔离**: 每次修复在独立 Git 分支进行
- ✅ **智能识别**: 自动识别简单/中等/复杂问题
- ✅ **人工介入**: 复杂问题停止并请求人工规划
- ✅ **自动回滚**: 遇到无法修复的问题自动回滚所有更改

## 🚀 快速开始

### 1. 检查依赖

Auto-Fix 依赖以下技能，请确保已安装：

- **deployment-test**: 部署测试技能

查看已安装技能：
```
Claude Code: 我们目前安装了哪些skills
```

### 2. 初始化配置

在项目根目录运行：
```
python -m skills.auto-fix --init-config
```

这会生成 `auto-fix.config.json` 配置文件。

### 3. 修改配置

根据项目实际情况修改配置文件：

```json
{
  "version": "1.0",
  "project": {
    "root": "Project",
    "backendPath": "Project/ShengBeiDjango",
    "frontendPath": "Project/ShengBeiVue"
  },
  "test": {
    "configPath": "test.config.json",
    "reportDir": "test_reports",
    "testScriptsPath": "../deployment-test/scripts"
  },
  "fix": {
    "autoCommit": true,
    "maxIterations": 10,
    "strategy": "balanced",
    "stopOnComplexProblem": true,
    "rollbackOnComplexProblem": true
  },
  "git": {
    "branchPrefix": "auto-fix",
    "autoMerge": true,
    "deleteBranchAfterMerge": true
  }
}
```

**关键配置项**:

- `project.root`: 项目根目录（相对路径）
- `project.backendPath`: 后端路径（Django）
- `project.frontendPath`: 前端路径（Vue）
- `fix.maxIterations`: 最大修复迭代次数（默认 10）
- `fix.rollbackOnComplexProblem`: 遇到复杂问题是否回滚（默认 true）
- `git.autoMerge`: 修复成功后是否自动合并到 main 分支

### 4. 运行 Auto-Fix

在项目根目录运行：
```
python -m skills.auto-fix
```

## 🔄 工作流程

```
┌─────────────────────────────────────┐
│ 1. 文档完整性检查                    │
│    检查 CLAUDE.md, INDEX.md 是否存在  │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 2. 创建修复分支                       │
│    auto-fix-20250105-143000          │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│ 3. 运行测试                           │
│    调用 deployment-test 技能          │
└──────────────┬──────────────────────┘
               │
               ▼
         ┌─────────┐
         │测试通过? │
         └────┬────┘
              │
     ┌────────┴────────┐
     │                 │
    Yes               No
     │                 │
     ▼                 ▼
┌──────────┐   ┌──────────────────┐
│合并到main│   │ 4. 分析问题        │
└──────────┘   │    解析测试报告    │
               └────────┬─────────┘
                        │
                        ▼
               ┌──────────────────┐
               │ 5. 分类问题        │
               │    config/database│
               │    /api/frontend  │
               └────────┬─────────┘
                        │
                        ▼
               ┌──────────────────┐
               │ 6. 三阶段修复      │
               │    阶段0: 配置     │
               │    阶段1: 后端链   │
               │    阶段2: 前端     │
               └────────┬─────────┘
                        │
                        ▼
               ┌──────────────────┐
               │ 7. Git 提交       │
               │    每个修复独立提交│
               └────────┬─────────┘
                        │
                        ▼
               ┌──────────────────┐
               │ 8. 重新测试       │
               │    回到步骤3      │
               └──────────────────┘
```

## 🎯 问题分类与修复策略

### 阶段 0: 配置修复（优先级最高）

| 问题类型 | 自动修复 | 说明 |
|---------|---------|------|
| 端口未监听 | ✅ | 检查 `.env.local` 配置 |
| URL 配置错误 | ✅ | 替换硬编码域名 |
| 环境变量缺失 | ✅ | 创建 `.env.local` |

**示例**:
```
❌ MySQL (127.0.0.1:3306)... 未监听
→ Auto-Fix: 添加 MYSQL_HOST=127.0.0.1, MYSQL_PORT=3306
```

### 阶段 1: 后端依赖链修复

#### 1.1 数据库问题

| 问题类型 | 自动修复 | 说明 |
|---------|---------|------|
| 字段缺失 | ✅ | 生成 Django 迁移文件 |
| 迁移问题 | ✅ | 运行 `makemigrations` + `migrate` |
| 表缺失 | ❌ | 需要人工设计表结构 |

**示例**:
```
❌ 字段 'wallet_address' 在表 'pm_bot_config' 中缺失
→ Auto-Fix: 生成迁移文件添加字段
→ 运行: python manage.py migrate
```

#### 1.2 API 问题

| 问题类型 | 自动修复 | 说明 |
|---------|---------|------|
| 路由 404 | ✅ | 添加路由和视图模板 |
| 状态码错误 | ❌ | 需要人工分析 |
| 参数错误 | ❌ | 需要人工分析 |

**示例**:
```
❌ /api/pm-robot/create: 状态码: 预期 200, 实际 404
→ Auto-Fix: 添加路由到 urls.py
→ 创建视图函数模板
```

#### 1.3 认证问题

| 问题类型 | 自动修复 | 说明 |
|---------|---------|------|
| 权限错误 | ❌ | 需要人工分析 |
| 认证失败 | ❌ | 需要人工分析 |

### 阶段 2: 前端修复

| 问题类型 | 自动修复 | 说明 |
|---------|---------|------|
| 组件导入错误 | ✅ | 修复导入路径 |
| 选择器错误 | ❌ | 需要人工分析 |
| 渲染错误 | ❌ | 需要人工分析 |

**示例**:
```
❌ 组件 'PMWalletCreateDialog' 导入失败
→ Auto-Fix: 搜索组件文件
→ 计算正确的相对路径
→ 更新导入语句
```

## ⚠️ 修复边界

### ✅ 自动修复（简单问题）

- 配置文件错误（端口、URL、环境变量）
- 数据库字段缺失（可自动生成迁移）
- API 路由 404（可添加路由模板）
- 前端组件导入路径错误

### ⚠️ 半自动修复（中等问题）

- 状态码错误（生成解决方案，等待确认）
- 字段类型不匹配（建议修改，等待确认）

### ❌ 不自动修复（复杂问题）

- **架构重构**: 模块重组、设计模式变更
- **业务逻辑**: 功能实现、算法优化
- **数据模型**: 新表设计、关联关系变更
- **权限设计**: RBAC、ABAC 权限系统

遇到复杂问题时，Auto-Fix 会：

1. 停止修复流程
2. 列出需要人工规划的问题
3. 回滚所有已修复的更改（如果 `rollbackOnComplexProblem=true`）
4. 保留修复分支供人工检查

## 📋 使用场景

### 场景 1: 首次部署

```bash
# 1. 初始化配置
python -m skills.auto-fix --init-config

# 2. 修改配置（检查项目路径、数据库配置等）
vim auto-fix.config.json

# 3. 运行 Auto-Fix
python -m skills.auto-fix
```

**预期输出**:
```
======================================================================
  Auto-Fix - 全自动测试-修复循环系统
======================================================================

======================================================================
  文档完整性检查
======================================================================
✅ 文档完整性检查: 通过

======================================================================
  运行测试
======================================================================
...
❌ MySQL (127.0.0.1:3306)... 未监听
❌ Redis (127.0.0.1:6379)... 未监听

======================================================================
  问题分析
======================================================================
发现 2 个问题:
  1. [config] MySQL 端口未监听
     严重级别: simple
  2. [config] Redis 端口未监听
     严重级别: simple

======================================================================
  开始修复
======================================================================

======================================================================
  阶段 0: 配置修复
======================================================================
待修复问题: 2

🔧 修复问题: MySQL 端口未监听
   类别: config
   严重级别: simple
   修复 MySQL 端口配置...
✅ 已提交修复: MySQL 端口未监听: 已添加 MySQL 端口配置
✓ MySQL 端口未监听

[... 继续修复 ...]

======================================================================
  修复统计
======================================================================
总问题数: 2
已修复: 2
需要规划: 0
修复失败: 0

✅ 所有问题已修复

[... 重新测试 ...]

======================================================================
  Auto-Fix 完成
======================================================================
✅ 所有测试通过，已合并到主分支
总迭代次数: 1
```

### 场景 2: 遇到复杂问题

```bash
python -m skills.auto-fix
```

**预期输出**:
```
======================================================================
  问题分析
======================================================================
发现 1 个问题:
  1. [database] 表 'pm_bot_wallet' 不存在
     严重级别: complex

======================================================================
  开始修复
======================================================================

🔧 修复问题: 表 'pm_bot_wallet' 不存在
   类别: database
   严重级别: complex
   创建缺失表...
⚠ 表 'pm_bot_wallet' 不存在: 缺失表需要人工设计表结构
⚠ 表 'pm_bot_wallet' 不存在

======================================================================
  修复统计
======================================================================
总问题数: 1
已修复: 0
需要规划: 1
修复失败: 0

⚠️  发现复杂问题，需要提前规划
请检查上述问题，设计解决方案后再运行

正在回滚所有修复...
⚠️ 已回滚所有修复

修复未完成，修复分支已保留
修复分支: auto-fix-20250105-143000
```

**下一步**:

1. 检查 `auto-fix-20250105-143000` 分支
2. 设计缺失表的结构
3. 手动创建模型和迁移
4. 再次运行 `python -m skills.auto-fix`

## 🔧 故障排查

### 问题 1: 配置文件不存在

**错误**:
```
⚠️  配置文件不存在: auto-fix.config.json
ℹ️  将使用默认配置
```

**解决**:
```bash
python -m skills.auto-fix --init-config
```

### 问题 2: 文档缺失

**警告**:
```
⚠️  文档缺失:
  - Project/CLAUDE.md
  - Project/ShengBeiDjango/INDEX.md

⚠️  建议先补充缺失的文档后再运行 Auto-Fix
是否继续？ (y/n):
```

**解决**:
- 补充缺失的文档（推荐）
- 或输入 `y` 继续（不推荐，修复标准不明确）

### 问题 3: 不是 Git 仓库

**错误**:
```
❌ 不是 Git 仓库
```

**解决**:
```bash
git init
git add .
git commit -m "Initial commit"
```

### 问题 4: 测试脚本不存在

**错误**:
```
❌ 测试脚本路径不存在: ../deployment-test/scripts
```

**解决**:

检查 `deployment-test` 技能是否安装：
```
Claude Code: 我们目前安装了哪些skills
```

如果没有安装，需要先安装 `deployment-test` 技能。

### 问题 5: 达到最大迭代次数

**警告**:
```
⚠️  达到最大迭代次数 (10)
⚠️  修复分支已保留
修复分支: auto-fix-20250105-143000
```

**原因**:

可能存在循环依赖或无法自动修复的问题。

**解决**:

1. 检查修复分支的提交历史
2. 分析失败原因
3. 手动修复后再次运行

或增加最大迭代次数：
```json
{
  "fix": {
    "maxIterations": 20
  }
}
```

## 📊 高级配置

### 禁用自动合并

如果不想自动合并到主分支：

```json
{
  "git": {
    "autoMerge": false
  }
}
```

Auto-Fix 会保留修复分支，你可以手动检查后合并。

### 禁用复杂问题回滚

如果想在遇到复杂问题时保留已修复的更改：

```json
{
  "fix": {
    "rollbackOnComplexProblem": false
  }
}
```

### 自定义修复分支前缀

```json
{
  "git": {
    "branchPrefix": "my-fix"
  }
}
```

分支名变为: `my-fix-20250105-143000`

### 禁用特定类别的修复

例如禁用前端自动修复：

```json
{
  "categories": {
    "frontend": {
      "enabled": false
    }
  }
}
```

## 🛠️ 开发者指南

### 添加新的修复器

1. 在 `fix_executor.py` 中添加新的修复方法：

```python
def fix_new_category(self, problem):
    """修复新类别问题"""
    # 实现修复逻辑
    return {"success": True, "message": "修复成功"}
```

2. 在 `fix()` 方法中注册：

```python
fixer_map = {
    "config": self.fix_config,
    "new_category": self.fix_new_category,
    # ...
}
```

3. 在 `problem_analyzer.py` 中添加解析逻辑：

```python
def _analyze_new_category_failures(self, report_data):
    """分析新类别失败"""
    # 实现解析逻辑
    return problems
```

### 自定义问题分类

修改 `problem_analyzer.py` 中的正则表达式：

```python
# 示例: 匹配新的错误格式
new_failures = re.findall(
    r'你的错误格式',
    content
)
```

## 📝 相关文档

- [AUTO-FIX-DESIGN.md](AUTO-FIX-DESIGN.md) - 完整系统设计文档
- [AUTO-FIX-BOUNDARIES.md](AUTO-FIX-BOUNDARIES.md) - 修复边界与决策树
- [SKILL.md](SKILL.md) - 技能定义

## 🤝 反馈与贡献

如果遇到问题或有改进建议，请：

1. 检查相关文档
2. 查看 Git 修复分支的提交历史
3. 手动修复后再次运行

---

**版本**: 1.0.0
**更新时间**: 2025-01-05
**作者**: Auto-Fix System
