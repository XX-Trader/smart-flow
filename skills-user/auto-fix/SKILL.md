---
name: auto-fix
displayName: "自动修复"
version: "1.0.0"
description: 全自动测试-修复循环系统。自动运行测试、分析问题、修复代码、验证修复、Git 提交，直到所有测试通过。适用于 Django + Vue 全栈项目。

triggers:
  keywords:
    - "auto-fix"
    - "自动修复"
    - "修复测试"
    - "循环修复"

  auto_trigger: false
  confidence_threshold: 0.7

tools:
  required:
    - Read
    - Write
  optional:
    - Bash
    - Edit

permissions:
  level: "write"
  scope:
    - "file:read"
    - "file:write"

context:
  mode: inline
  isolation: false
  max_context_tokens: 50000

hot_reload: true
progressive_load: true

metadata:
  category: "testing"
  tags:
    "auto"
    "fix"
  author: "Smart Flow Team"
  license: "MIT"
  updated_at: "2026-01-12"

scope:
  level: "project"
  priority: 40

compatibility:
  claude_code_min_version: "2026.01.0"
  requires_restart: false
---

# Auto-Fix - 全自动测试-修复循环系统

## 🎯 技能特性

- 🤖 **单次修复**: 测试 → 分析问题 → 自动修复 → Git 提交
- 📊 **智能分类**: 自动识别配置/数据库/API/前端 4 大类问题
- 📚 **文档优先**: 优先参考 CLAUDE.md、INDEX.md 等项目文档
- 🌿 **Git 分支安全**: 在独立分支修复，避免影响主分支
- ⚡ **三阶段策略**: 配置 → 后端依赖链 → 前端（按依赖顺序）
- ✅ **增量提交**: 修复一个大类提交一次，避免大冲突
- 🔄 **可循环**: 配合"循环"技能实现自动循环，直到所有测试通过

---

## 🚀 快速开始

### 方式一：命令行脚本（最简单）

**Windows 用户**:
```bash
# 双击运行或在命令行执行
auto-fix.bat

# 或者带参数运行
auto-fix.bat --init-config
```

**Linux/macOS 用户**:
```bash
# 给脚本添加执行权限
chmod +x auto-fix.py

# 运行脚本
./auto-fix.py
```

### 方式二：Python 模块调用

```bash
# 在项目根目录调用
python auto-fix.py

# 初始化配置文件
python auto-fix.py --init-config
```

### 方式三：通过 Claude Code 调用

```
/auto-fix
```

或直接说：

```
使用 auto-fix 技能
```

```
运行自动修复
```

### 方式四：配合循环技能（自动循环）

```
使用 auto-fix 直到所有测试通过
```

或使用循环技能：

```
循环 auto-fix 直到测试通过
```

---

## 📋 使用流程

### 单次执行模式（默认）

Auto-Fix 默认执行单次修复流程：

```
步骤 1: 文档检查
  └─> 验证 CLAUDE.md、INDEX.md 等文档

步骤 2: 创建修复分支
  └─> auto-fix-{timestamp}

步骤 3: 运行测试
  └─> 调用 deployment-test 技能

步骤 4: 分析问题
  └─> 分类为 config/database/api/frontend

步骤 5: 修复问题
  └─> 三阶段修复（配置 → 后端链 → 前端）

步骤 6: Git 提交
  └─> 修复成功后提交并合并
```

### 循环执行模式（推荐）

配合"循环"技能实现自动循环：

```
/auto-fix
  └─> 测试 → 分析 → 修复 → 提交
       └─> 仍有问题？
            └─> 循环 /auto-fix
                 └─> 继续测试 → 分析 → 修复
                      └─> 直到所有测试通过
```

**使用方法**：

```
循环 auto-fix 直到测试通过
```

或

```
循环 auto-fix 最多10次
```

---

### 步骤 1: 配置检查

首次运行会自动检查：
```
✅ 文档完整性检查
✅ 复杂问题识别
✅ 修复边界确认
```

### 步骤 2: 初始测试

运行完整的测试套件：
```
🧪 运行端口检测...
🧪 运行 API 测试...
🧪 运行 UI 测试...
```

### 步骤 3: 问题分析与分类

自动分类问题：
```
📊 发现 15 个问题:
  - 配置问题: 3 个
  - 数据库问题: 2 个
  - API 问题: 5 个
  - 前端问题: 5 个
```

### 步骤 4: 三阶段修复

```
阶段 0: 配置修复 (最快)
  └─> 修复端口、URL、环境变量

阶段 1: 后端依赖链修复
  ├─> 数据库 → API → 认证
  └─> 按依赖顺序修复

阶段 2: 前端修复
  └─> 依赖后端稳定后修复
```

### 步骤 5: 循环验证

```
修复 → 测试 → 验证 → 提交 → 再测试
  ↑                              │
  └──────── 循环直到全部通过 ─────┘
```

### 步骤 6: 完成合并

```
✅ 所有测试通过
✅ 合并到主分支
✅ 删除修复分支
```

---

## 🛠️ 配置文件

### 生成配置文件

首次运行会自动生成配置模板：

```bash
python -m skills.auto-fix --init-config
```

生成的配置文件：`auto-fix.config.json`

### 配置示例

```json
{
  "version": "1.0",

  "project": {
    "root": "Project",
    "backendPath": "Project/ShengBeiDjango",
    "frontendPath": "Project/ShengBeiVue"
  },

  "test": {
    "configPath": "test.config.json",
    "reportDir": "test_reports"
  },

  "fix": {
    "autoCommit": true,
    "maxIterations": 10,
    "strategy": "balanced"
  },

  "git": {
    "branchPrefix": "auto-fix",
    "autoMerge": true
  },

  "categories": {
    "config": {
      "enabled": true,
      "priority": 0,
      "stage": 0,
      "autoFix": true
    },
    "database": {
      "enabled": true,
      "priority": 1,
      "stage": 1,
      "autoFix": true
    },
    "api": {
      "enabled": true,
      "priority": 2,
      "stage": 1,
      "autoFix": true
    },
    "auth": {
      "enabled": true,
      "priority": 3,
      "stage": 1,
      "autoFix": true
    },
    "frontend": {
      "enabled": true,
      "priority": 4,
      "stage": 2,
      "autoFix": true
    }
  }
}
```

---

## 🔧 修复边界

### ✅ 自动修复

- 配置错误（端口、URL、环境变量）
- 缺失路由（404）
- 缺失数据库字段
- 组件导入错误
- 元素选择器错误

### ⚠️ 半自动修复（需要确认）

- 字段类型不匹配（影响兼容性）
- 响应格式变更（多个可行方案）
- 权限配置（涉及安全性）

### ❌ 不自动修复（复杂问题）

- 架构重构问题
- 业务逻辑问题
- 性能优化问题
- 安全漏洞修复
- 依赖升级问题

**遇到复杂问题时，系统会停止并报告，等待人工规划。**

---

## 📚 文档依赖

Auto-Fix 系统依赖以下文档，请确保文档完整：

### 必需文档

- [ ] `CLAUDE.md` - 项目规范与架构
- [ ] `Project/INDEX.md` - 项目总索引
- [ ] `Project/ShengBeiDjango/INDEX.md` - 后端索引
- [ ] `Project/ShengBeiVue/INDEX.md` - 前端索引

### 可选文档

- [ ] `CLAUDE_FULL.md` - 完整文档
- [ ] `Project/ShengBeiDjango/pm_robot/INDEX.md` - 核心模块索引
- [ ] `Project/ShengBeiDjango/accounts/INDEX.md` - 认证模块索引

**如果文档缺失，系统会提示先补充文档。**

---

## 🔄 三阶段修复策略

### 阶段 0: 快速配置修复

```
配置类问题 (端口、环境变量、URL)
   └─> 修复快，影响所有服务 ✅
```

### 阶段 1: 后端依赖链修复

```
优先级 A: 数据库问题 (表结构、字段、迁移)
   └─> 后端基础，API 依赖数据 ✅

优先级 B: API 接口问题 (路由、参数、响应)
   └─> 前端依赖 API 返回数据 ✅

优先级 C: 认证/权限问题
   └─> accounts 相关逻辑 ✅
```

### 阶段 2: 前端修复

```
前端组件问题 (渲染、选择器、状态)
   └─> 用户可见，需后端数据支持 ✅
```

### 阶段 3: 集成测试

```
前后端联调测试
   └─> 验证完整功能链路 ✅
```

**设计理念**:
- 依赖优先：底层先修复（数据库 → API → 前端）
- 配置先行：配置问题是所有服务的基础
- 分阶段验证：每个阶段结束后重新测试
- 避免 Mock：使用真实后端支持前端测试

---

## 📊 修复示例

### 完整流程示例

```bash
$ python -m skills.auto-fix

========================================================================
  Auto-Fix - 全自动测试-修复循环系统
========================================================================

✅ 文档完整性检查: 通过
✅ 复杂问题识别: 无复杂问题
✅ 修复边界确认: 已确认

🔧 创建修复分支: auto-fix-20260105-143000
📊 运行初始测试...

========================================================================
  初始测试结果
========================================================================
总计: 15 个问题
  - 配置: 3 个
  - 数据库: 2 个
  - API: 5 个
  - 前端: 5 个

========================================================================
  阶段 0: 配置修复
========================================================================

🔧 修复配置问题 (3 个)
   ✅ 修复 MySQL 端口配置
   ✅ 修复 Redis 连接配置
   ✅ 修复后端 URL 配置

[Git] fix(config): 修复 3 个配置问题
🧪 重新测试... 12 个问题

========================================================================
  阶段 1: 后端依赖链修复
========================================================================

📊 修复数据库问题 (2 个)
   ✅ 添加缺失字段 wallet_address
   ✅ 执行数据库迁移

[Git] fix(database): 修复 2 个数据库问题
🧪 重新测试... 10 个问题

🔌 修复 API 问题 (5 个)
   ✅ 修复 /api/pm-robot/create 路由
   ✅ 修复响应字段缺失
   ✅ 修复认证逻辑
   ✅ 修复请求参数验证
   ✅ 修复 HTTP 状态码

[Git] fix(api): 修复 5 个 API 问题
🧪 重新测试... 5 个问题

========================================================================
  阶段 2: 前端修复
========================================================================

🎨 修复前端问题 (5 个)
   ✅ 修复 PMWalletCreateDialog 组件导入
   ✅ 修复元素选择器 #wallet-address
   ✅ 修复 API 调用 URL
   ✅ 修复状态管理逻辑
   ✅ 修复条件渲染

[Git] fix(frontend): 修复 5 个前端问题
🧪 重新测试...

========================================================================
  阶段 3: 集成测试
========================================================================

✅ 所有测试通过!

[Git] 合并到主分支
[Git] 删除修复分支

========================================================================
  Auto-Fix 完成
========================================================================
✅ 所有测试通过，已合并到主分支
```

---

## 🛡️ 安全机制

### Git 分支保护

```
main (主分支)
  └─> auto-fix-{timestamp} (修复分支)
       ├─> fix/config
       ├─> fix/database
       ├─> fix/api
       └─> fix/frontend
```

- ✅ 始终在独立分支修复
- ✅ 每个大类修复后提交一次
- ✅ 验证通过后才合并主分支
- ✅ 失败可回滚

### 修复回滚

如果修复失败：
```
1. 自动回滚到最后一次成功提交
2. 记录失败原因
3. 标记问题为"复杂问题"
4. 停止修复，等待人工规划
```

---

## 📝 注意事项

### 前置规划

遇到以下问题必须**提前规划**（不在自动修复范围）：

- 🔴 架构设计问题（模块职责、循环依赖、数据模型）
- 🔴 业务逻辑问题（计算逻辑、业务规则、状态机）
- 🔴 安全性问题（认证授权、数据加密、注入风险）
- 🔴 性能问题（响应时间、内存占用、缓存策略）
- 🔴 依赖升级问题（版本冲突、库废弃）

**处理流程**:
```
1. 停止自动修复
2. 生成问题分析报告
3. 等待人工规划完成
4. 更新文档规范
5. 重新启动 Auto-Fix
```

### 修复原则

- ✅ **执行者**: Auto-Fix 是执行者，不是决策者
- ✅ **文档优先**: 所有修复都基于文档规范
- ✅ **确定性**: 只修复确定的、文档化的问题
- ❌ **不做决策**: 不做架构性、业务逻辑的决策

---

## 🔗 相关技能

- [deployment-test](../deployment-test/) - 部署后测试技能
- [windows-fullstack-deploy](../windows-fullstack-deploy/) - Windows 本地部署

---

## 📖 更多信息

详细设计文档: [AUTO-FIX-DESIGN.md](./AUTO-FIX-DESIGN.md)
修复边界说明: [AUTO-FIX-BOUNDARIES.md](./AUTO-FIX-BOUNDARIES.md)

---

**技能版本**: 1.0
**最后更新**: 2026-01-05
**适用平台**: Windows 10/11, Linux, macOS
**适用项目**: Django + Vue 全栈项目
