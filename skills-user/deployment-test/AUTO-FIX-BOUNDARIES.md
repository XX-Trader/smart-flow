# Auto-Fix 系统边界与前置规划

> **版本**: 1.0
> **日期**: 2026-01-05
> **状态**: 设计阶段

---

## 🚨 核心原则

> **Auto-Fix 系统是执行者，不是决策者**
>
> - ✅ 能做的：执行**确定的、文档化的、规范化的**修复
> - ❌ 不能做的：做**架构性的、业务逻辑的、需要权衡**的决策

---

## 1. 修复边界定义

### 1.1 ✅ 自动修复范围（确定性修复）

| 类别 | 能修的问题 | 修复依据 | 成功率 |
|------|-----------|---------|--------|
| **配置** | 端口、URL、环境变量错误 | CLAUDE.md 规范 | 95% |
| **数据库** | 缺失字段、表、迁移 | models.py 定义 | 90% |
| **API 路由** | 404 路由缺失 | urls.py + API 文档 | 85% |
| **API 参数** | 缺失必需参数 | API 文档 + views.py | 80% |
| **前端导入** | 组件未导入 | 组件结构文档 | 90% |
| **前端选择器** | 元素选择器错误 | 组件代码 | 85% |
| **字段映射** | 前后端字段不匹配 | API 响应定义 | 75% |

**特点**:
- ✅ 有明确的正确答案（文档中有定义）
- ✅ 修复路径唯一且确定
- ✅ 风险可控（可以回滚）

---

### 1.2 ⚠️ 半自动修复（需要确认）

| 类别 | 问题 | 需要确认原因 | 处理方式 |
|------|------|-------------|---------|
| **API 响应** | 响应字段多余 | 可能是业务逻辑变更 | 生成 2-3 个方案供选择 |
| **字段类型** | 字段类型不匹配 | 可能影响兼容性 | 询问用户：修改字段类型 OR 修改转换逻辑 |
| **认证逻辑** | 权限验证失败 | 涉及安全性 | 询问用户：添加权限 OR 修改为公开 |
| **组件替换** | 组件已废弃 | 需要选择替代方案 | 询问用户：使用新组件 OR 恢复旧组件 |
| **数据迁移** | 数据格式变更 | 可能丢失数据 | 询问用户：是否执行迁移脚本 |

**特点**:
- ⚠️ 有多个可行方案
- ⚠️ 需要用户权衡利弊
- ⚠️ 可能影响兼容性或安全性

---

### 1.3 ❌ 不自动修复（复杂问题）

| 类别 | 问题示例 | 原因 | 处理方式 |
|------|---------|------|---------|
| **架构设计** | 模块职责不清、循环依赖 | 需要重新设计架构 | 报告问题，等待人工规划 |
| **业务逻辑** | 计算逻辑错误、业务规则冲突 | 需要理解业务意图 | 报告问题，提供分析 |
| **性能优化** | 响应慢、内存占用高 | 需要权衡多种方案 | 报告问题，提供优化建议 |
| **安全漏洞** | SQL 注入、XSS 漏洞 | 需要安全专家评估 | 报告问题，标记为严重 |
| **依赖升级** | 第三方库冲突、版本不兼容 | 需要测试兼容性 | 报告问题，提供升级指南 |
| **数据库重构** | 表结构需要重大调整 | 可能丢失数据 | 报告问题，等待重构方案 |
| **API 重大变更** | 接口废弃、签名变更 | 影响所有调用方 | 报告问题，等待迁移计划 |

**特点**:
- ❌ 没有明确的"正确答案"
- ❌ 需要跨模块协调
- ❌ 影响范围大、风险高
- ❌ 需要领域知识或业务理解

---

## 2. 复杂问题识别标准

### 2.1 识别维度

| 维度 | 简单问题 | 中等问题 | 复杂问题 |
|------|---------|---------|---------|
| **影响范围** | 单个文件/函数 | 2-5 个文件 | 跨模块/整个系统 |
| **修改数量** | 1-5 行代码 | 5-20 行代码 | 20+ 行代码 OR 多个文件 |
| **依赖关系** | 无依赖 | 依赖 1-2 个模块 | 依赖 3+ 个模块 |
| **风险等级** | 低（容易回滚） | 中（需要测试） | 高（影响核心功能） |
| **确定性** | 100% 确定 | 2-3 个可行方案 | 不确定，需要探索 |
| **文档支持** | 文档明确说明 | 文档部分说明 | 文档缺失或冲突 |
| **业务影响** | 无业务影响 | 可能影响部分功能 | 影响核心业务流程 |
| **数据影响** | 无数据影响 | 可能需要数据迁移 | 需要复杂的数据迁移 |

### 2.2 识别决策树

```
开始
  │
  ├─> 文档有明确定义？
  │   ├─ 是 ──> 影响范围 < 3 个文件？
  │   │   ├─ 是 ──> ✅ 简单问题 (直接修复)
  │   │   └─ 否 ──> ⚠️ 中等问题 (生成方案)
  │   │
  │   └─ 否 ──> 需要 2+ 个模块协调？
  │       ├─ 是 ──> ❌ 复杂问题 (报告)
  │       └─ 否 ──> ⚠️ 中等问题 (生成方案)
```

### 2.3 具体判断示例

**示例 1: 简单问题**
```python
# 问题: API 路由 404
# 原因: urls.py 缺少路由定义
# 文档: API 文档明确说明该路由路径
# 修复: 在 urls.py 添加一行路由
# 结论: ✅ 简单问题 (直接修复)
```

**示例 2: 中等问题**
```python
# 问题: API 返回字段类型不匹配
# 原因: 模型定义是 Integer，但前端需要 String
# 文档: 文档中未明确说明字段类型
# 方案:
#   1. 修改模型字段类型为 String (可能影响其他调用方)
#   2. 在序列化器中转换类型 (只影响当前接口)
#   3. 修改前端适配 Integer (影响前端)
# 结论: ⚠️ 中等问题 (询问用户选择)
```

**示例 3: 复杂问题**
```python
# 问题: 用户余额计算错误
# 原因: 计算逻辑分布在多个服务中，存在重复计算
# 影响: 所有涉及金额的功能
# 文档: 文档中未定义计算规则
# 需要: 重新设计金额计算架构，统一计算逻辑
# 结论: ❌ 复杂问题 (报告，等待人工规划)
```

---

## 3. 前置规划流程

### 3.1 修复前的准备工作

#### 步骤 1: 文档完整性检查 ✅

**检查清单**:
```markdown
## 项目文档检查
- [ ] CLAUDE.md 存在且包含完整的项目规范
- [ ] CLAUDE_FULL.md 包含详细的架构设计
- [ ] Project/INDEX.md 包含项目总索引
- [ ] Project/ShengBeiDjango/INDEX.md 包含后端索引
- [ ] Project/ShengBeiVue/INDEX.md 包含前端索引
- [ ] 核心模块有对应的 INDEX.md 或 README.md

## API 文档检查
- [ ] 所有 API 接口都有文档说明
- [ ] API 请求参数有明确定义
- [ ] API 响应格式有明确定义
- [ ] HTTP 状态码使用规范有说明
- [ ] 认证方式有说明

## 数据模型文档
- [ ] 核心模型有字段说明
- [ ] 模型关系有说明 (ForeignKey, ManyToMany)
- [ ] 数据库迁移策略有说明
- [ ] 索引设计有说明

## 前端组件文档
- [ ] 核心组件有功能说明
- [ ] 组件 props 有类型定义
- [ ] 组件事件有说明
- [ ] 组件依赖关系清晰
```

**如果文档缺失**:
```
❌ 错误做法: 猜测文档应该是什么，然后修复
✅ 正确做法:
  1. 报告文档缺失问题
  2. 列出缺失的文档清单
  3. 等待用户补充文档后再修复
```

#### 步骤 2: 复杂问题前置规划 ✅

**如果初始测试发现复杂问题**:
```
1. 停止自动修复流程
2. 生成复杂问题分析报告
3. 等待人工规划完成
4. 更新文档规范
5. 重新启动自动修复
```

**复杂问题分析报告模板**:
```markdown
# 复杂问题分析报告

## 问题概述
- 发现时间: 2026-01-05 14:30:00
- 问题类型: 架构设计问题
- 严重级别: 🔴 严重

## 问题描述
用户余额计算逻辑分布在多个模块中：
- pm_robot/models.py: calculate_balance()
- accounts/models.py: get_user_balance()
- pm_robot/services.py: compute_balance()

这些函数的实现不一致，导致结果冲突。

## 影响范围
- 涉及模块: pm_robot, accounts
- 影响功能: 余额查询、充值、提现、交易
- 数据影响: 可能导致金额显示错误

## 建议的规划方向
1. 统一余额计算逻辑到一个服务
2. 其他模块调用统一服务
3. 更新相关文档
4. 添加单元测试

## 需要的人工决策
- [ ] 确认余额计算的权威逻辑
- [ ] 确定统一服务的位置
- [ ] 确认迁移计划
- [ ] 确认测试策略

## 修复状态
⏸️ 等待人工规划完成后再继续自动修复
```

#### 步骤 3: 修复边界确认 ✅

**在开始修复前，向用户确认**:
```markdown
## 修复边界确认

### 本次修复范围
- ✅ 配置问题: 端口、URL、环境变量
- ✅ 数据库问题: 缺失字段、表
- ✅ API 问题: 路由、参数、响应格式
- ✅ 前端问题: 组件导入、选择器

### 不在本次修复范围
- ❌ 架构重构问题
- ❌ 业务逻辑问题
- ❌ 性能优化问题
- ❌ 安全漏洞修复
- ❌ 依赖升级

### 修复策略
- 简单问题: 直接修复
- 中等问题: 生成方案，等待确认
- 复杂问题: 报告，停止修复流程

### Git 策略
- 创建修复分支: auto-fix-{timestamp}
- 每个大类修复后提交一次
- 验证通过后合并到主分支

是否开始修复？(y/n)
```

---

## 4. 每个修复器的详细决策树

### 4.1 配置修复器决策树

```
检测到配置问题
  │
  ├─> 问题类型？
  │   │
  │   ├─ 端口未监听
  │   │   │
  │   │   ├─> 服务已安装？
  │   │   │   ├─ 是 ──> 服务已启动？
  │   │   │   │   ├─ 是 ──> 端口配置正确？
  │   │   │   │   │   ├─ 是 ──> 端口被占用？
  │   │   │   │   │   │   ├─ 是 ──> 修改端口 ✅
  │   │   │   │   │   │   └─ 否 ──> 报告: 未知原因 ❌
  │   │   │   │   │   └─ 否 ──> 修正端口配置 ✅
  │   │   │   │   └─ 否 ──> 启动服务 ✅
  │   │   │   └─ 否 ──> 报告: 服务未安装 ❌
  │   │   │
  │   ├─ URL 错误
  │   │   │
  │   │   ├─> 文档中有定义？
  │   │   │   ├─ 是 ──> 修改 URL ✅
  │   │   │   └─ 否 ──> 报告: 文档缺失 ❌
  │   │   │
  │   └─ 环境变量缺失
  │       │
  │       ├─> 有默认值？
  │       │   ├─ 是 ──> 使用默认值 ✅
  │       │   └─ 否 ──> 报告: 需要用户输入 ❌
```

### 4.2 数据库修复器决策树

```
检测到数据库问题
  │
  ├─> 问题类型？
  │   │
  │   ├─ 表不存在
  │   │   │
  │   │   ├─> models.py 中有定义？
  │   │   │   ├─ 是 ──> 生成迁移文件 ✅
  │   │   │   │        └─> 执行迁移 ✅
  │   │   │   └─ 否 ──> 报告: 模型未定义 ❌
  │   │   │
  │   ├─ 字段不存在
  │   │   │
  │   │   ├─> models.py 中有定义？
  │   │   │   ├─ 是 ──> 迁移文件存在？
  │   │   │   │   ├─ 是 ──> 执行迁移 ✅
  │   │   │   │   └─ 否 ──> 生成迁移 ✅
  │   │   │   │        └─> 执行迁移 ✅
  │   │   │   └─ 否 ──> 报告: 字段未定义 ❌
  │   │   │
  │   ├─ 字段类型不匹配
  │   │   │
  │   │   ├─> 影响范围？
  │   │   │   ├─ 单个模型 ──> 修改字段类型 ✅
  │   │   │   │            └─> 生成迁移 ✅
  │   │   │   └─ 多个模型 ──> ⚠️ 中等问题
  │   │   │                 └─> 询问用户: 修改类型 OR 添加转换逻辑
  │   │   │
  │   └─ 外键约束错误
  │       │
  │       ├─> 模型关系定义错误？
  │       │   ├─ 是 ──> 修正模型定义 ✅
  │       │   │        └─> 生成迁移 ✅
  │       │   └─ 否 ──> 数据问题？
  │       │       ├─ 是 ──> ⚠️ 中等问题
  │       │       │      └─> 询问用户: 是否清理脏数据
  │       │       └─ 否 ──> 报告: 原因不明 ❌
```

### 4.3 API 修复器决策树

```
检测到 API 问题
  │
  ├─> HTTP 状态码？
  │   │
  │   ├─ 404 Not Found
  │   │   │
  │   │   ├─> 路由定义存在？
  │   │   │   ├─ 是 ──> 视图函数存在？
  │   │   │   │   ├─ 是 ──> 报告: 路径冲突 ❌
  │   │   │   │   └─ 否 ──> 添加视图函数 ✅
  │   │   │   └─ 否 ──> 文档中有定义？
  │   │   │       ├─ 是 ──> 添加路由 ✅
  │   │   │       └─ 否 ──> ⚠️ 中等问题
  │   │   │                └─> 询问: 是否添加新接口
  │   │   │
  │   ├─ 500 Internal Server Error
  │   │   │
  │   │   ├─> 查看错误日志
  │   │   │   │
  │   │   │   ├─ 数据库错误？
  │   │   │   │   └─> 转到数据库修复器
  │   │   │   │
  │   │   │   ├─ 代码逻辑错误？
  │   │   │   │   └─> 是否有明确修复方法？
  │   │   │   │       ├─ 是 ──> 修复代码 ✅
  │   │   │   │       └─ 否 ──> 报告: 逻辑错误 ❌
  │   │   │   │
  │   │   │   └─ 导入错误？
  │   │   │       ├─ 模块存在？
  │   │   │       │   ├─ 是 ──> 修复导入路径 ✅
  │   │   │       │   └─ 否 ──> 报告: 模块缺失 ❌
  │   │   │       │
  │   │   │
  │   ├─ 400 Bad Request
  │   │   │
  │   │   ├─> 参数验证失败
  │   │   │   │
  │   │   │   ├─> 必需参数缺失？
  │   │   │   │   ├─ 文档有定义？
  │   │   │   │   │   ├─ 是 ──> 前端添加参数 ✅
  │   │   │   │   │   └─ 否 ──> ⚠️ 中等问题
  │   │   │   │   │            └─> 询问: 修改API OR 修改前端
  │   │   │   │   │
  │   │   │   │   └─ 参数格式错误？
  │   │   │   │       ├─ 文档有定义？
  │   │   │   │       │   ├─ 是 ──> 修改参数格式 ✅
  │   │   │   │       │   └─ 否 ──> 报告: 文档缺失 ❌
  │   │   │   │
  │   │   │   └─> 参数类型错误
  │   │   │       └─> 类似处理
  │   │   │
  │   └─ 401/403 Unauthorized/Forbidden
  │       │
  │       ├─> 认证问题？
  │       │   ├─ Token 缺失？
  │       │   │   └─> 前端添加 Token ✅
  │       │   │
  │       │   ├─ Token 过期？
  │       │   │   └─> 前端刷新 Token ✅
  │       │   │
  │       │   └─> 权限问题？
  │       │       ├─> 文档有权限定义？
  │       │       │   ├─ 是 ──> ⚠️ 中等问题
  │       │       │   │   └─> 询问: 添加权限 OR 修改为公开
  │       │       │   └─ 否 ──> 报告: 权限未定义 ❌
```

### 4.4 前端修复器决策树

```
检测到前端问题
  │
  ├─> 问题类型？
  │   │
  │   ├─ 页面 404
  │   │   │
  │   │   ├─> 路由定义存在？
  │   │   │   ├─ 是 ──> 组件导入正确？
  │   │   │   │   ├─ 是 ──> 报告: 路由冲突 ❌
  │   │   │   │   └─ 否 ──> 添加导入 ✅
  │   │   │   └─ 否 ──> 文档中有定义？
  │   │   │       ├─ 是 ──> 添加路由 ✅
  │   │   │       └─ 否 ──> ⚠️ 中等问题
  │   │   │                └─> 询问: 是否添加新页面
  │   │   │
  │   ├─ 组件未渲染
  │   │   │
  │   │   ├─> 组件已导入？
  │   │   │   ├─ 是 ──> 条件渲染条件？
  │   │   │   │   ├─ 是 ──> 检查条件逻辑 ✅
  │   │   │   │   └─ 否 ──> 数据未加载？
  │   │   │   │       └─> 检查 API 调用
  │   │   │   │
  │   │   │   └─ 否 ──> 组件存在？
  │   │   │       ├─ 是 ──> 添加导入 ✅
  │   │   │       └─ 否 ──> 报告: 组件不存在 ❌
  │   │   │
  │   ├─ 元素未找到
  │   │   │
  │   │   ├─> 选择器正确？
  │   │   │   ├─ 是 ──> 元素在 DOM 中？
  │   │   │   │   ├─ 是 ──> 更新选择器 ✅
  │   │   │   │   └─ 否 ──> 组件未正确渲染
  │   │   │   │       └─> 转到"组件未渲染"
  │   │   │   │
  │   │   │   └─ 否 ──> 更新选择器 ✅
  │   │   │
  │   ├─ API 调用失败
  │   │   │
  │   │   ├─> URL 配置正确？
  │   │   │   ├─ 是 ──> 转到 API 修复器
  │   │   │   └─ 否 ──> 修正 URL ✅
  │   │   │
  │   └─ 状态管理错误
  │       │
  │       ├─> Store 定义存在？
  │       │   ├─ 是 ──> Action/Getter 存在？
  │       │   │   ├─ 是 ──> 检查调用逻辑 ✅
  │       │   │   └─ 否 ──> 添加 Action/Getter ✅
  │       │   │
  │       │   └─ 否 ──> 报告: Store 未定义 ❌
```

---

## 5. 修复成功标准

### 5.1 验证标准

每个修复完成后，必须满足：

```python
# 修复成功标准
def verify_fix(problem, fix_result):
    """验证修复是否成功"""

    # 1. 测试通过
    assert fix_result.test_passed == True

    # 2. 没有引入新问题
    assert fix_result.new_failures == []

    # 3. Git 提交成功
    assert fix_result.git_commit_success == True

    # 4. 代码符合规范
    assert fix_result.code_quality_check == True

    # 5. 文档已更新（如果需要）
    if problem.requires_doc_update:
        assert fix_result.doc_updated == True
```

### 5.2 回滚标准

如果修复失败，必须回滚：

```python
# 需要回滚的情况
rollback_conditions = [
    "测试未通过",              # 修复后测试仍然失败
    "引入新问题",              # 修复导致其他功能失败
    "Git 提交失败",            # 无法提交代码
    "代码规范检查失败",        # 代码不符合规范
    "用户明确要求回滚",        # 用户不满意修复结果
]
```

---

## 6. 错误处理与回滚策略

### 6.1 错误分类

| 错误类型 | 处理方式 | 是否回滚 |
|---------|---------|---------|
| 修复执行失败 | 记录日志，跳过该问题 | 否 |
| 修复后测试失败 | 回滚该修复，标记为复杂问题 | 是 |
| Git 提交失败 | 记录日志，停止修复 | 否 |
| 引入新问题 | 回滚该修复 | 是 |
| 文档冲突 | 停止修复，报告用户 | 否 |

### 6.2 回滚流程

```python
def rollback_fix(git_manager, commit_hash):
    """回滚修复"""

    # 1. 记录回滚原因
    log_rollback_reason(commit_hash)

    # 2. Git 回滚
    git_manager.reset_to_commit(commit_hash)

    # 3. 重新测试
    test_results = run_all_tests()

    # 4. 验证回滚成功
    if test_results.before_rollback == test_results.after_rollback:
        print("✅ 回滚成功")
    else:
        print("❌ 回滚失败，需要人工介入")

    # 5. 将问题标记为"复杂问题"
    mark_problem_as_complex(problem)
```

---

## 7. 文档更新规范

### 7.1 何时更新文档

修复过程中，如果发现以下情况，必须更新文档：

```markdown
## 文档更新触发条件

- [ ] 发现文档与实现不一致
- [ ] 添加了新的 API 接口
- [ ] 修改了数据模型
- [ ] 修改了配置项
- [ ] 添加了新的前端组件
- [ ] 修改了认证逻辑
```

### 7.2 更新流程

```python
def update_documentation(problem, fix_details):
    """更新文档"""

    # 1. 识别需要更新的文档
    docs_to_update = identify_affected_docs(problem)

    # 2. 生成文档更新内容
    for doc in docs_to_update:
        update_content = generate_doc_update(doc, fix_details)

        # 3. 询问用户是否更新
        user_approval = ask_user(f"是否更新文档 {doc}?", update_content)

        # 4. 应用更新
        if user_approval:
            apply_doc_update(doc, update_content)
            git_manager.commit_fix('docs', f'更新 {doc} 文档')
```

---

## 8. 总结

### 8.1 Auto-Fix 系统能力边界

```
┌─────────────────────────────────────────────┐
│  ✅ Auto-Fix 能做什么                        │
├─────────────────────────────────────────────┤
│  • 修复明确的配置错误                         │
│  • 补充缺失的路由、字段、组件                 │
│  • 修正拼写错误、类型错误                     │
│  • 更新过时的选择器、URL                      │
│  • 执行数据库迁移                             │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  ⚠️ Auto-Fix 需要确认                        │
├─────────────────────────────────────────────┤
│  • 有多个可行方案的问题                       │
│  • 影响兼容性的修改                           │
│  • 涉及安全性的修改                           │
│  • 需要数据迁移的操作                         │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  ❌ Auto-Fix 不能做                          │
├─────────────────────────────────────────────┤
│  • 架构重构                                   │
│  • 业务逻辑修改                               │
│  • 性能优化                                   │
│  • 安全漏洞修复                               │
│  • 依赖升级                                   │
│  • 需要权衡的决策                             │
└─────────────────────────────────────────────┘
```

### 8.2 使用建议

**对于用户**:
1. ✅ **修复前**: 确保文档完整、规范明确
2. ✅ **修复中**: 关注中等问题的确认，及时决策
3. ✅ **修复后**: 审查复杂问题报告，制定规划

**对于 Auto-Fix 系统**:
1. ✅ 严格遵守修复边界
2. ✅ 遇到不确定的问题立即停止
3. ✅ 详细记录修复过程和失败原因
4. ✅ 确保每次修复都可以回滚

---

**文档版本**: 1.0
**最后更新**: 2026-01-05
**下一步**: 实施核心代码
