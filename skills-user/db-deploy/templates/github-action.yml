# ==============================================================================
# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# ==============================================================================
# ä½¿ç”¨è¯´æ˜:
# 1. å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ .github/workflows/deploy.yml
# 2. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½® Secrets (Settings â†’ Secrets and variables â†’ Actions)
# 3. æ¨é€ä»£ç åˆ° main åˆ†æ”¯å³å¯è‡ªåŠ¨è§¦å‘éƒ¨ç½²
# ==============================================================================

name: ğŸš€ Auto Deploy

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "18"

jobs:
  # ==============================================================================
  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  # ==============================================================================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    # å¹¶å‘æ§åˆ¶: åŒä¸€åˆ†æ”¯çš„å¤šæ¬¡æ¨é€åªæ‰§è¡Œæœ€åä¸€æ¬¡
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      # ------------------------------------------------
      # æ­¥éª¤ 1: æ£€æŸ¥ä»£ç 
      # ------------------------------------------------
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      # ------------------------------------------------
      # æ­¥éª¤ 2: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      # ------------------------------------------------
      - name: ğŸ“‹ Display deployment info
        run: |
          echo "ğŸš€ Deploying to production server..."
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ”— URL: https://${{ secrets.DOMAIN }}"

      # ------------------------------------------------
      # æ­¥éª¤ 3: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      # ------------------------------------------------
      - name: ğŸš€ Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          password: ${{ secrets.SERVER_PASSWORD }}  # å¤‡ç”¨: å¦‚æœæ²¡æœ‰é…ç½®å¯†é’¥
          script_stop: true  # é‡åˆ°é”™è¯¯åœæ­¢æ‰§è¡Œ
          debug: false  # è®¾ç½®ä¸º true å¯ç”¨è°ƒè¯•æ¨¡å¼

          # éƒ¨ç½²è„šæœ¬
          script: |
            # è®¾ç½®å˜é‡
            PROJECT_NAME="${{ secrets.PROJECT_NAME || 'my-project' }}"
            PROJECT_ROOT="/www/wwwroot/$PROJECT_NAME"
            DOMAIN="${{ secrets.DOMAIN }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"

            echo "ğŸ“ Project root: $PROJECT_ROOT"
            echo "ğŸŒ Domain: $DOMAIN"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd $PROJECT_ROOT || exit 1

            # ============================================================
            # æ›´æ–°ä»£ç 
            # ============================================================
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            # ============================================================
            # æ›´æ–°åç«¯
            # ============================================================
            echo "ğŸ Updating backend..."
            cd backend/Project/ShengBeiDjango || exit 1

            # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
            if [ -d "venv" ]; then
              source venv/bin/activate
            else
              echo "âŒ Virtual environment not found!"
              exit 1
            fi

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Installing Python dependencies..."
            pip install --upgrade pip
              pip install -r requirements.txt

            # æ•°æ®åº“è¿ç§»
            echo "ğŸ—„ï¸ Running database migrations..."
            python manage.py migrate --noinput

            # æ”¶é›†é™æ€æ–‡ä»¶
            echo "ğŸ“ Collecting static files..."
            python manage.py collectstatic --noinput

            # ============================================================
            # æ›´æ–°å‰ç«¯
            # ============================================================
            echo "ğŸ¨ Updating frontend..."
            cd $PROJECT_ROOT/frontend/Project/ShengBeiVue || exit 1

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Installing Node.js dependencies..."
            npm install

            # æ„å»ºå‰ç«¯
            echo "ğŸ”¨ Building frontend..."
              npm run build

            # ============================================================
            # é‡å¯æœåŠ¡
            # ============================================================
            echo "ğŸ”„ Restarting services..."
            sudo supervisorctl restart ${PROJECT_NAME}:django || echo "âš ï¸ Django service restart failed"
            sudo nginx -s reload || echo "âš ï¸ Nginx reload failed"

            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Website: https://$DOMAIN"

      # ------------------------------------------------
      # æ­¥éª¤ 4: éªŒè¯éƒ¨ç½²
      # ------------------------------------------------
      - name: ğŸ” Verify deployment
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10

          # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
          DOMAIN="${{ secrets.DOMAIN }}"
          if [ -n "$DOMAIN" ]; then
            echo "ğŸŒ Checking website: https://$DOMAIN"
            curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" https://$DOMAIN || echo "âš ï¸ Website check failed"
          fi

      # ------------------------------------------------
      # æ­¥éª¤ 5: å‘é€é€šçŸ¥ (å¯é€‰)
      # ------------------------------------------------
      - name: ğŸ“§ Send notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  Slack/Email/ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥

  # ==============================================================================
  # å¤‡ä»½æ•°æ® (å¯é€‰)
  # ==============================================================================
  backup:
    name: ğŸ“¦ Backup Database
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ—„ï¸ Backup database
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            PROJECT_NAME="${{ secrets.PROJECT_NAME || 'my-project' }}"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            BACKUP_DIR="/www/wwwroot/$PROJECT_NAME/backups/db"

            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p $BACKUP_DIR

            # å¤‡ä»½æ•°æ®åº“
            BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
            mysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_FILE

            # åˆ é™¤ 7 å¤©å‰çš„å¤‡ä»½
            find $BACKUP_DIR -name "db_backup_*.sql" -mtime +7 -delete

            echo "âœ… Backup completed: $BACKUP_FILE"

  # ==============================================================================
  # å¥åº·æ£€æŸ¥ (å¯é€‰)
  # ==============================================================================
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: ğŸ” Check service health
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            PROJECT_NAME="${{ secrets.PROJECT_NAME || 'my-project' }}"

            echo "ğŸ” Checking services status..."
            sudo supervisorctl status $PROJECT_NAME:*
            sudo systemctl status nginx --no-pager

            echo ""
            echo "ğŸ“Š Disk usage:"
            df -h | grep -E "Filesystem|/dev/"

            echo ""
            echo "ğŸ’¾ Memory usage:"
            free -h

# ==============================================================================
# å·¥ä½œæµé…ç½®è¯´æ˜
# ==============================================================================
#
# å¿…éœ€çš„ GitHub Secrets:
# ---------------------
# SERVER_HOST         - æœåŠ¡å™¨ IP åœ°å€
# SERVER_PORT         - SSH ç«¯å£ (å¯é€‰ï¼Œé»˜è®¤ 22)
# SERVER_USER         - SSH ç”¨æˆ·å
# SERVER_SSH_KEY      - SSH ç§é’¥ (æ¨è) æˆ– SERVER_PASSWORD
# PROJECT_NAME        - é¡¹ç›®åç§° (å¯é€‰ï¼Œé»˜è®¤ my-project)
# DOMAIN              - åŸŸå
# DB_NAME             - æ•°æ®åº“åç§°
# DB_USER             - æ•°æ®åº“ç”¨æˆ·
# DB_PASSWORD         - æ•°æ®åº“å¯†ç 
#
# å¯é€‰çš„ GitHub Secrets:
# ---------------------
# DJANGO_SECRET_KEY   - Django å¯†é’¥ (å¦‚æœéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆå¯çœç•¥)
#
# è§¦å‘æ–¹å¼:
# ---------------------
# 1. è‡ªåŠ¨: æ¨é€ä»£ç åˆ° main æˆ– master åˆ†æ”¯
# 2. æ‰‹åŠ¨: åœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 3. PR: åˆ›å»ºæˆ–æ›´æ–° Pull Request
#
# æ•…éšœæ’æŸ¥:
# ---------------------
# 1. æŸ¥çœ‹è¿è¡Œæ—¥å¿—: ä»“åº“ â†’ Actions â†’ é€‰æ‹©è¿è¡Œè®°å½•
# 2. å¯ç”¨è°ƒè¯•æ¨¡å¼: å°†æ­¥éª¤ 3 çš„ debug è®¾ç½®ä¸º true
# 3. æœ¬åœ°æµ‹è¯• SSH: ssh -i ~/.ssh/id_ed255 user@server
#
# ==============================================================================
