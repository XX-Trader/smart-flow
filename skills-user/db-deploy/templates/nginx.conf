# ==============================================================================
# Nginx 配置模板
# ==============================================================================
# 使用说明:
# 1. 复制此文件到 /etc/nginx/conf.d/your-project.conf
# 2. 替换变量: ${PROJECT_NAME}, ${DOMAIN}, ${PROJECT_ROOT} 等
# 3. 测试配置: sudo nginx -t
# 4. 重载配置: sudo systemctl reload nginx
# ==============================================================================

# ------------------------------------------------------------------------------
# Upstream 配置 (Django 后端)
# ------------------------------------------------------------------------------
upstream ${PROJECT_NAME}_backend {
    # 使用 Unix Socket (推荐，性能更好)
    server unix:///tmp/${PROJECT_NAME}-django.sock;

    # 或使用 TCP (备选方案)
    # server 127.0.0.1:8000;

    # 负载均衡配置 (如果有多个 worker)
    # least_conn;  # 最少连接负载均衡
}

# ------------------------------------------------------------------------------
# HTTP 服务器配置
# ------------------------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;

    server_name ${DOMAIN} ${WWW_DOMAIN} ${API_DOMAIN};

    # 访问日志
    access_log ${PROJECT_ROOT}/logs/nginx-access.log;
    error_log ${PROJECT_ROOT}/logs/nginx-error.log;

    # 字符集
    charset utf-8;

    # 客户端上传大小限制
    client_max_body_size 100M;

    # ------------------------------------------------------------------------------
    # 前端静态文件
    # ------------------------------------------------------------------------------
    location / {
        alias ${PROJECT_ROOT}/frontend/Project/ShengBeiVue/dist/;
        try_files $uri $uri/ /index.html;

        # 缓存配置
        expires 7d;
        add_header Cache-Control "public, immutable";

        # Gzip 压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript
                   application/x-javascript application/xml+rss
                   application/javascript application/json;
    }

    # ------------------------------------------------------------------------------
    # Django API 接口
    # ------------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://${PROJECT_NAME}_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # WebSocket 支持 (如果需要)
        # proxy_http_version 1.1;
        # proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection "upgrade";
    }

    # ------------------------------------------------------------------------------
    # Django 静态文件 (MEDIA)
    # ------------------------------------------------------------------------------
    location /media/ {
        alias ${PROJECT_ROOT}/backend/Project/ShengBeiDjango/media/;
        expires 30d;
        add_header Cache-Control "public";

        # 安全配置: 防止目录遍历
        autoindex off;
    }

    # ------------------------------------------------------------------------------
    # Django 静态文件 (STATIC)
    # ------------------------------------------------------------------------------
    location /static/ {
        alias ${PROJECT_ROOT}/backend/Project/ShengBeiDjango/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";

        # 安全配置
        autoindex off;
    }

    # ------------------------------------------------------------------------------
    # 健康检查端点 (可选)
    # ------------------------------------------------------------------------------
    location /health/ {
        proxy_pass http://${PROJECT_NAME}_backend;
        proxy_set_header Host $host;
        access_log off;
    }

    # ------------------------------------------------------------------------------
    # 安全配置
    # ------------------------------------------------------------------------------

    # 隐藏 Nginx 版本
    server_tokens off;

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 限流配置 (可选)
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # location /api/ {
    #     limit_req zone=api_limit burst=20 nodelay;
    #     # ... 其他配置
    # }
}

# ------------------------------------------------------------------------------
# HTTPS 配置 (使用 Let's Encrypt SSL 证书后自动添加)
# ------------------------------------------------------------------------------
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#
#     server_name ${DOMAIN} ${WWW_DOMAIN} ${API_DOMAIN};
#
#     # SSL 证书配置 (certbot 会自动添加)
#     # ssl_certificate /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
#     # ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;
#     # include /etc/letsencrypt/options-ssl-nginx.conf;
#     # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # SSL 优化
#     ssl_session_timeout 1d;
#     ssl_session_cache shared:SSL:50m;
#     ssl_session_tickets off;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#
#     # HSTS (可选)
#     add_header Strict-Transport-Security "max-age=31536000" always;
#
#     # 安全头部
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "no-referrer-when-downgrade" always;
#
#     # ... 其他配置同上
# }

# ------------------------------------------------------------------------------
# HTTP 重定向到 HTTPS (可选)
# ------------------------------------------------------------------------------
# server {
#     listen 80;
#     listen [::]:80;
#     server_name ${DOMAIN} ${WWW_DOMAIN} ${API_DOMAIN};
#
#     # 重定向所有 HTTP 请求到 HTTPS
#     return 301 https://$server_name$request_uri;
# }

# ==============================================================================
# 配置说明
# ==============================================================================
#
# 变量替换:
# -----------
# ${PROJECT_NAME}  - 项目名称 (如: dabl-quant)
# ${DOMAIN}        - 主域名 (如: example.com)
# ${WWW_DOMAIN}    - www 子域名 (如: www.example.com)
# ${API_DOMAIN}    - API 子域名 (如: api.example.com)
# ${PROJECT_ROOT}  - 项目根目录 (如: /www/wwwroot/dabl-quant)
#
# 性能优化:
# -----------
# 1. 启用 Gzip 压缩 - 减少传输数据量
# 2. 配置缓存 - 静态文件设置过期时间
# 3. 使用 Unix Socket - 比 TCP 性能更好
# 4. 调整缓冲区大小 - 根据实际情况调整
#
# 安全加固:
# -----------
# 1. 隐藏 Nginx 版本 - server_tokens off
# 2. 配置 SSL/TLS - 使用 Let's Encrypt 免费证书
# 3. 添加安全头部 - X-Frame-Options, X-Content-Type-Options 等
# 4. 限制请求大小 - client_max_body_size
# 5. 禁止访问敏感文件 - location ~ /\. 和 ~ ~$
#
# 监控配置:
# -----------
# 1. 配置访问日志 - access_log
# 2. 配置错误日志 - error_log
# 3. 健康检查端点 - location /health/
#
# ==============================================================================
